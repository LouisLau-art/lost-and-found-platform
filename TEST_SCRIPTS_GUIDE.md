# 测试脚本使用指南

本文档说明如何使用项目中的测试脚本。

---

## 📁 脚本位置

所有测试脚本位于 `backend/` 目录下：

```
backend/
├── set_louis_admin.py              # 设置管理员权限
├── generate_large_test_data.py     # 生成测试数据
└── test_smart_matching_system.py   # 系统集成测试
```

---

## 🔧 使用方法

### 1. 设置管理员权限

**用途**: 将指定用户设置为管理员

**使用方法**:
```bash
cd backend
python set_louis_admin.py
```

**功能**:
- 查找名字或邮箱包含"Louis"的用户
- 将该用户的 `is_admin` 字段设置为 `True`
- 如果用户已经是管理员，则跳过

**输出示例**:
```
============================================================
设置Louis为管理员
============================================================
正在连接数据库...

找到 1 个匹配的用户：
1. Louis (1397951685@qq.com) - 已是管理员

✅ 无需更新，所有匹配用户已经是管理员
============================================================
```

---

### 2. 生成测试数据

**用途**: 批量生成随机测试数据，包括用户、帖子、认领、评论、通知

**使用方法**:
```bash
cd backend
python generate_large_test_data.py
```

**依赖安装**:
```bash
pip install faker
```

**生成的数据**:
- ✅ 50个测试用户
- ✅ 150个测试帖子（包含lost和found类型）
- ✅ 80个认领请求（包含pending、approved、rejected、cancelled状态）
- ✅ 200条评论
- ✅ 150条通知

**数据特点**:
- 帖子涵盖10个分类（电子产品、证件卡类、钥匙等）
- 地点分布在30多个校园位置
- 时间跨度为最近30天
- 数据具有真实性和多样性

**输出示例**:
```
======================================================================
开始生成随机测试数据
======================================================================

找到 10 个分类：
  - 电子产品
  - 证件卡类
  - 钥匙
  ...

正在生成 50 个测试用户...
✓ 成功生成 50 个用户

正在生成 150 个测试帖子...
✓ 成功生成 150 个帖子

正在生成 80 个测试认领请求...
✓ 成功生成 80 个认领请求

正在生成 200 个测试评论...
✓ 成功生成 200 个评论

正在生成 150 个测试通知...
✓ 成功生成 150 个通知

======================================================================
✅ 所有测试数据生成完成！
======================================================================

统计信息：
  - 新增用户: 50 个
  - 新增帖子: 150 个
  - 新增认领请求: 80 个
  - 新增评论: 200 条
  - 新增通知: 150 条

您现在可以在论坛和管理后台看到这些测试数据了！
```

---

### 3. 系统集成测试

**用途**: 测试智能匹配算法和消息推送功能

**使用方法**:
```bash
cd backend
python test_smart_matching_system.py
```

**测试内容**:
1. ✅ 测试数据创建
2. ✅ 智能匹配算法测试
3. ✅ 认领请求与消息推送测试
4. ✅ 认领批准通知测试
5. ✅ 完整工作流程测试

**测试场景**:
- 创建失物帖（丢失iPhone）
- 创建拾得帖（捡到iPhone，相同地点）
- 创建干扰帖（捡到iPhone，不同地点）
- 验证智能匹配能找到正确的帖子并排除干扰
- 模拟认领请求并验证通知发送
- 模拟批准认领并验证通知发送

**输出示例**:
```
======================================================================
开始系统集成测试 - 智能匹配与消息推送
======================================================================

🧹 清理旧的测试数据...
✓ 清理完成

📝 创建测试数据...

🔍 测试智能匹配算法...

📬 测试认领请求和消息推送...

✅ 测试认领批准通知...

🔄 测试完整工作流程...

======================================================================
测试结果汇总
======================================================================

✅ PASS - 测试数据创建
✅ PASS - 智能匹配算法
✅ PASS - 认领请求与消息推送
✅ PASS - 认领批准通知
✅ PASS - 完整工作流程测试

======================================================================
总计: 5 个测试
通过: 5 ✅
失败: 0 ❌
通过率: 100.0%
======================================================================
```

---

## 🎯 完整测试流程

**推荐的完整测试步骤**:

```bash
# 1. 进入backend目录
cd backend

# 2. 设置管理员权限（仅首次需要）
python set_louis_admin.py

# 3. 生成测试数据
python generate_large_test_data.py

# 4. 运行系统测试
python test_smart_matching_system.py
```

---

## 🔍 测试后验证

### 在论坛前端验证

1. 访问论坛列表页面
2. 应该能看到150个随机生成的帖子
3. 帖子类型包含"丢失"和"拾到"
4. 帖子分类多样化

### 在管理后台验证

1. 使用Louis账号登录（已设置为管理员）
2. 访问 `/admin/posts` 管理员帖子管理页面
3. 应该能看到所有生成的帖子
4. 可以编辑和删除帖子

### 测试智能匹配

1. 创建一个失物帖（例如：丢失手机）
2. 记录地点和分类
3. 查看智能匹配推荐
4. 应该能看到相同地点、相同分类的拾得帖

### 测试消息推送

1. 对一个帖子发起认领请求
2. 检查帖子作者的通知列表
3. 应该收到"新的认领请求"通知
4. 批准或拒绝认领
5. 认领者应该收到相应的批准/拒绝通知

---

## ⚠️ 注意事项

1. **数据库备份**: 运行测试脚本前建议备份数据库
2. **重复运行**: 测试数据生成脚本可以重复运行，会持续添加新数据
3. **清理测试数据**: 集成测试脚本会自动清理自己创建的测试数据
4. **环境要求**: 确保已安装所有依赖（faker）

---

## 📚 相关文档

- [系统测试报告](../SYSTEM_TEST_REPORT.md) - 详细的测试结果和分析
- [管理员功能文档](../ADMIN_POSTS_FEATURE.md) - 管理员功能说明
- [管理员功能测试指南](../ADMIN_POSTS_TESTING.md) - 管理员功能测试步骤

---

## 🐛 问题排查

### 问题1: ModuleNotFoundError: No module named 'faker'

**解决方案**:
```bash
pip install faker
```

### 问题2: 数据库连接失败

**解决方案**:
- 检查 `DATABASE_URL` 环境变量
- 确保数据库服务正在运行
- 检查数据库权限

### 问题3: 测试失败

**解决方案**:
- 检查数据库中是否存在分类数据
- 确保后端API服务正常运行
- 查看详细的错误日志

---

## 💡 提示

- 测试脚本使用的是实际的数据库，不是模拟数据
- 生成的测试数据具有真实性，可用于演示
- 测试脚本会输出详细的日志，便于调试
- 所有测试都是幂等的，可以安全地重复执行

---

**最后更新**: 2025-10-24  
**维护者**: 开发团队
